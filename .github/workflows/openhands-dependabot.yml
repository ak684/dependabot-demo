# OpenHands Dependabot Auto-Fix Workflow
#
# This workflow automatically invokes OpenHands to analyze and fix
# dependency update PRs created by Dependabot (or simulated updates).
#
# Trigger conditions:
# 1. Dependabot creates a PR (github.actor == 'dependabot[bot]')
# 2. A PR is labeled with 'dependencies' (for manual/simulated triggers)
#
# What OpenHands does:
# 1. Analyzes the dependency changes
# 2. Runs the test suite to identify breaking changes
# 3. If tests fail, attempts to fix the code
# 4. Commits fixes and updates the PR

name: OpenHands Dependabot Auto-Fix

on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  # First, check if this is a dependency update PR
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      dependency_info: ${{ steps.metadata.outputs.dependency-names }}
      update_type: ${{ steps.metadata.outputs.update-type }}
    steps:
      - name: Check if Dependabot or dependency PR
        id: check
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Triggered by Dependabot"
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Triggered by 'dependencies' label"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Not a dependency update PR, skipping"
          fi

      - name: Fetch Dependabot metadata
        if: github.actor == 'dependabot[bot]'
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

  # Run tests first to see if there are any failures
  test-check:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.test.outputs.passed }}
      test_output: ${{ steps.test.outputs.output }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests and capture result
        id: test
        continue-on-error: true
        run: |
          set +e
          output=$(pytest tests/ -v 2>&1)
          exit_code=$?
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

  # If tests fail, invoke OpenHands to fix
  openhands-fix:
    needs: [check-trigger, test-check]
    if: needs.check-trigger.outputs.should_run == 'true' && needs.test-check.outputs.tests_passed == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Comment on PR - Starting fix
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **OpenHands Auto-Fix**: Tests are failing after dependency update. Starting automated fix...\n\n<details><summary>Test Output</summary>\n\n```\n${{ needs.test-check.outputs.test_output }}\n```\n</details>'
            })

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenHands
        run: |
          python -m pip install --upgrade pip
          pip install openhands-ai

      - name: Run OpenHands Resolver
        env:
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'anthropic/claude-sonnet-4-20250514' }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create instruction for OpenHands
          cat > /tmp/instruction.txt << 'EOF'
          A dependency update PR has caused test failures. Your task:

          1. First, run the tests to see the exact failures:
             pytest tests/ -v

          2. Analyze the test output to understand what broke

          3. The most likely cause is Pydantic v1 to v2 migration. Common changes needed:
             - .dict() -> .model_dump()
             - .parse_obj() -> .model_validate()
             - from_orm() -> model_validate()
             - class Config with orm_mode -> model_config = ConfigDict(from_attributes=True)
             - @validator -> @field_validator with mode='before' or mode='after'

          4. Make the minimum changes needed to fix the tests

          5. Run tests again to verify the fix works

          Do NOT change the dependency versions - fix the code to work with the new versions.
          EOF

          python -m openhands.resolver.resolve_issue \
            --repo "${{ github.repository }}" \
            --issue-number ${{ github.event.pull_request.number }} \
            --issue-type pr \
            --max-iterations 30

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: update code for dependency compatibility

          Automated fix by OpenHands for dependency update.
          - Updated Pydantic v1 syntax to v2
          - Fixed breaking API changes"
          git push

      - name: Comment on PR - Fix complete
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **OpenHands Auto-Fix**: Pushed fixes for the dependency update. Please review the changes and re-run CI.'
            })

      - name: Comment on PR - No fix needed
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **OpenHands Auto-Fix**: Could not automatically fix the test failures. Manual intervention may be required.'
            })

  # If tests pass, auto-approve and optionally merge
  auto-approve:
    needs: [check-trigger, test-check]
    if: needs.check-trigger.outputs.should_run == 'true' && needs.test-check.outputs.tests_passed == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Auto-approve PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: '‚úÖ **OpenHands Auto-Review**: All tests pass with the updated dependencies. Approved!'
            })
